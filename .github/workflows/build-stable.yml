name: 'Build (Stable)'

on:
  workflow_dispatch:

jobs:
  
  build:

    runs-on: [self-hosted, linux, x64]

    steps:

      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Setting up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10.12'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt

      - name: Update Pip and install requirements
        run: |
           pip install -U pip
           pip install -r requirements.txt
           pip install -U nuitka

      - name: Install compilers
        run: |
          sudo apt update
          sudo apt install -y gcc-aarch64-linux-gnu zip patchelf          

      - name: Build for Linux ARM64
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get download python3.10:arm64
          mkdir python3.10-arm64
          dpkg-deb -R python3.10*.deb python3.10-arm64/
          export PYTHONPATH=python3.10-arm64/usr/lib/python3.10/
          export LD_LIBRARY_PATH=python3.10-arm64/usr/lib:$LD_LIBRARY_PATH

          CC=aarch64-linux-gnu-gcc python -m nuitka --python-version=3.10 python3.10-arm64/usr/bin/python3 --follow-imports --onefile --standalone main.py
          cd build
          mv main.bin onedisc
          zip -r "/tmp/OneDisc-Linux-ARM64.zip" ./onedisc

